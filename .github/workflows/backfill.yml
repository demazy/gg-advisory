name: backfill-2025-jan-to-sep
on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate monthly digests (Janâ†’Sep 2025, DEBUG)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODE: backfill-months
          START_YM: "2025-01"
          END_YM:   "2025-09"

          # Intake/quality knobs
          ITEMS_PER_SECTION: "6"
          MIN_TEXT_CHARS: "350"
          PER_DOMAIN_CAP: "3"
          MIN_TOTAL_ITEMS: "1"   # keep digest even if few items

          # Priority-domain leniency
          PRIORITY_MIN_CHARS: "250"
          PRIORITY_DOMAINS: "aemo.com.au,arena.gov.au,cefc.com.au,ifrs.org,efrag.org,dcceew.gov.au,ec.europa.eu,commission.europa.eu"

          # Hybrid PDF extraction
          MAX_PDF_BYTES: "5242880"
          PDF_TRUSTED: "aemo.com.au,ifrs.org,efrag.org,dcceew.gov.au,arena.gov.au,cefc.com.au,irena.org"

          # ðŸ”§ Debug artifacts (drops/selected per month)
          DEBUG: "1"
        run: python -m src.generate_monthly

      - name: Sanity check workspace & out
        if: always()
        run: |
          echo "PWD = $(pwd)"
          ls -la out/ 2>/dev/null || echo "no ./out directory"
          echo "---- FIND debug artifacts ----"
          find out -maxdepth 1 -type f -name 'debug-*.txt' -o -name 'debug-*.json' -print || true

      - name: List debug files
        if: always()
        run: |
          echo "---- OUT ----"
          ls -lh out/ || true
          echo "---- META ----"
          cat out/debug-meta-2025-02.txt || true
          echo "---- DROPS (first 40) ----"
          head -n 40 out/debug-drops-2025-02.txt || true
          echo "---- SELECTED ----"
          cat out/debug-selected-2025-02.json || true


      - name: Commit outputs (digests + debug)
        run: |
          git config user.name "content-bot"
          git config user.email "content-bot@example.com"
          git add -f out/monthly-digest-2025-*.md out/debug-*.*
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "backfill: monthly digests Janâ€“Sep 2025 (with debug)"
            git push
          fi

      - name: Email backfill outputs (iCloud)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.me.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GG Advisory | Backfill digests (Janâ€“Sep 2025)"
          from: "GG Advisory <${{ secrets.MAIL_USERNAME }}>"
          to: "a.demazy_de_fortet@icloud.com"
          body: |
            âœ… Backfill complete (Janâ€“Sep 2025).
            Monthly digests are attached. Debug artifacts are committed under /out.
            Repo: https://github.com/${{ github.repository }}/tree/main/out
          attachments: |
            out/monthly-digest-2025-*.md
            out/debug-selected-2025-*.json
            out/debug-drops-2025-*.txt

