name: backfill-2025-jan-sep
on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate monthly digests (Jan→Sep 2025)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODE: backfill-months
          START_YM: "2025-01"
          END_YM:   "2025-09"

          # ----- Content tuning -----
          ITEMS_PER_SECTION: "7"
          PER_DOMAIN_CAP: "3"
          MIN_TEXT_CHARS: "300"
          PRIORITY_MIN_CHARS: "200"
          MIN_TOTAL_ITEMS: "1"

          PRIORITY_DOMAINS: "aemo.com.au,arena.gov.au,cefc.com.au,ifrs.org,efrag.org,dcceew.gov.au"
          MODEL: gpt-4o-mini
          TEMP: "0.2"

          # ----- Hybrid PDF capture -----
          MAX_PDF_BYTES: "5242880"
          PDF_TRUSTED: "aemo.com.au,ifrs.org,efrag.org,dcceew.gov.au,arena.gov.au,cefc.com.au,irena.org"

          # ----- Debug -----
          DEBUG: "1"

        run: python -m src.generate_monthly

      - name: List debug files
        if: always()
        run: |
          echo "---- OUT DIR CONTENTS ----"
          ls -lh out/ | sed -n '1,200p'
          echo "---- DEBUG DROPS (first 20 lines) ----"
          head -n 20 out/debug-drops-*.txt || echo "no drop logs found"
          echo "--------------------------------------"

      - name: Commit outputs
        run: |
          git config user.name "content-bot"
          git config user.email "content-bot@example.com"
          git add -f out/monthly-digest-2025-*.md
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "backfill: monthly digests Jan–Sep 2025"
            git push
          fi

      - name: Email backfill outputs (iCloud)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.me.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GG Advisory | Backfill Digests (Jan–Sep 2025)"
          from: "content-bot@gg-advisory.org"
          to: "a.demazy_de_fortet@icloud.com"
          body: |
            ✅ Backfill complete.
            This message includes monthly digests for Jan–Sep 2025 and debug logs.
            You can also browse them here:
            https://github.com/${{ github.repository }}/tree/main/out
          attachments: |
            out/monthly-digest-2025-*.md
            out/debug-selected-2025-*.json
            out/debug-drops-2025-*.txt
