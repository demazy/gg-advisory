name: backfill-2025-jan-to-oct
on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate monthly digest (Feb 2025, DEBUG)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODE: backfill-months
          START_YM: "2025-02"
          END_YM:   "2025-02"
      
          # Make intake a bit more permissive for debugging
          ITEMS_PER_SECTION: "6"
          MIN_TEXT_CHARS: "350"
          PER_DOMAIN_CAP: "3"
          MIN_TOTAL_ITEMS: "1"            # allow digest when 1+ item survives
      
          # Priority-domain leniency (short AU/EU pages that link to PDFs)
          PRIORITY_MIN_CHARS: "250"
          PRIORITY_DOMAINS: "aemo.com.au,arena.gov.au,cefc.com.au,ifrs.org,efrag.org,dcceew.gov.au,ec.europa.eu,commission.europa.eu"
      
          # Hybrid PDF extraction
          MAX_PDF_BYTES: "5242880"
          PDF_TRUSTED: "aemo.com.au,ifrs.org,efrag.org,dcceew.gov.au,arena.gov.au,cefc.com.au,irena.org"
      
          # ðŸ”§ Turn on debug to emit drop logs and pool snapshots
          DEBUG: "1"
        run: python -m src.generate_monthly

                    
      - name: List debug files
        if: always()
        run: |
          echo "---- OUT DIR ----"
          ls -lh out/ | sed -n '1,200p' || true
          echo "---- DEBUG DROPS (first 80 lines) ----"
          head -n 80 out/debug-drops-2025-02.txt || echo "no debug-drops file"
          echo "---- DEBUG POOLS ----"
          ls -lh out/debug-pool-*2025-02*.json || echo "no pool snapshots"
          echo "---- DEBUG SELECTED ----"
          cat out/debug-selected-2025-02.json 2>/dev/null || echo "no debug-selected file"

      - name: Commit outputs
        run: |
          git config user.name "content-bot"
          git config user.email "content-bot@example.com"
          git add -f out/monthly-digest-2025-*.md
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "backfill: monthly digests Janâ€“Oct 2025"
            git push
          fi

      # --- Email the generated backfill files via iCloud SMTP ---
      # Set repo secrets: MAIL_USERNAME (your iCloud address), MAIL_PASSWORD (app-specific password)
      - name: Email backfill outputs (iCloud)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.me.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GG Advisory | Backfill digests (Janâ€“Oct 2025)"
          from: "content-bot@gg-advisory.org"
          to: "a.demazy_de_fortet@icloud.com"
          body: |
            âœ… Backfill complete.

            This message includes monthly digests for Janâ€“Oct 2025 as attachments.
            You can also browse them here:
            https://github.com/${{ github.repository }}/tree/main/out
          attachments: out/monthly-digest-2025-*.md
