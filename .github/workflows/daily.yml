name: daily-content

on:
  schedule:
    - cron: "10 20 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Persist the state/seen URLs across runs so we don't repost
      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: state
          key: state-${{ github.ref_name }}

      # Ensure state file exists & is valid JSON (safe no-op if already valid)
      - name: Prime/validate state
        run: |
          mkdir -p state
          python - <<'PY'
          import json, pathlib
          p = pathlib.Path("state/seen_urls.json")
          try:
              if not p.exists() or p.stat().st_size == 0:
                  p.write_text(json.dumps({"seen":[]}, indent=2), encoding="utf-8")
              else:
                  json.loads(p.read_text(encoding="utf-8"))
          except Exception:
              p.write_text(json.dumps({"seen":[]}, indent=2), encoding="utf-8")
          PY

      - name: Generate posts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TIMEZONE: Australia/Melbourne
          ITEMS_PER_SECTION: "3"          # reduce while testing
          FRESH_DAYS: "45"           # tighten to 30 if needed
          MODEL: gpt-4o-mini
          TEMP: "0.25"
          SLEEP_BETWEEN_SECTIONS: "8.0"   # more spacing
          MIN_TEXT_CHARS: "600"      # raise to 800 if you want denser articles
          MAX_TEXT_CHARS: "3600"          # smaller payload
          FAIL_ON_OPENAI_ERRORS: "false"  # keep workflow green if quota hits
        run: python -m src.generate_posts
      
      - name: Commit & push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "auto: signals $(date -u +'%Y-%m-%d')"
          commit_user_name: content-bot
          commit_user_email: content-bot@example.com
          branch: ${{ github.ref_name }}
      
      - name: Set DATE_SLUG
        run: echo "DATE_SLUG=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Email outputs (iCloud)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.me.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GG Advisory | Signals — ${{ env.DATE_SLUG }}"
          from: "content-bot@gg-advisory.org"
          to: "a.demazy_de_fortet@icloud.com"
          body: |
            ✅ GG Advisory auto-content run succeeded.

            The combined Markdown report for today is attached.

            —
            GG Advisory Content Bot
          attachments: out/signals-${{ env.DATE_SLUG }}.md

