name: daily-content
on:
  schedule:
    - cron: "10 20 * * *"   # runs 20:10 UTC daily
  workflow_dispatch: {}
  permissions:
    contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Persist the state/seen URLs across runs so we don't repost
      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: state
          key: state-${{ github.ref_name }}

      # Ensure state file exists & is valid JSON (safe no-op if already valid)
      - name: Prime/validate state
        run: |
          mkdir -p state
          python - <<'PY'
          import json, pathlib
          p = pathlib.Path("state/seen_urls.json")
          try:
              if not p.exists() or p.stat().st_size == 0:
                  p.write_text(json.dumps({"seen":[]}, indent=2), encoding="utf-8")
              else:
                  json.loads(p.read_text(encoding="utf-8"))
          except Exception:
              p.write_text(json.dumps({"seen":[]}, indent=2), encoding="utf-8")
          PY

      - name: Generate posts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TIMEZONE: Australia/Melbourne
          ITEMS_PER_SECTION: "3"          # reduce while testing
          MODEL: gpt-4o-mini
          TEMP: "0.25"
          SLEEP_BETWEEN_SECTIONS: "8.0"   # more spacing
          MAX_TEXT_CHARS: "1200"          # smaller payload
          FAIL_ON_OPENAI_ERRORS: "false"  # keep workflow green if quota hits
        run: python -m src.generate_posts
      
      - name: Commit & push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "auto: signals $(date -u +'%Y-%m-%d')"
          commit_user_name: content-bot
          commit_user_email: content-bot@example.com
          branch: ${{ github.ref_name }}
      

