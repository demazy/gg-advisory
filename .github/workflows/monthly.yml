# === BEGIN .github/workflows/monthly.yml ===
name: Monthly Digest

on:
  schedule:
    - cron: "41 0 10 * *"
  workflow_dispatch:
    inputs:
      year:
        description: "Year (YYYY)"
        required: false
        default: ""
      month:
        description: "Month (1-12)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: monthly-digest
  cancel-in-progress: false

jobs:
  run-monthly:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest
        shell: bash
        run: |
          set -euo pipefail
          git pull --rebase origin main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Sanity check _in_range()
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import inspect
          import src.generate_monthly as gm

          print("Loaded:", gm.__file__)
          src = inspect.getsource(gm._in_range)
          print("--- _in_range() source ---")
          print(src)
          print("--- end ---")

          if "return start_ts <= ts <= end_ts" in src:
              raise SystemExit("ERROR: old _in_range() still present")
          if "_coerce_ts" not in src:
              raise SystemExit("ERROR: _in_range() is not coercing timestamp types")
          print("OK: _in_range looks robust")
          PY

      - name: Compute month
        id: month
        shell: bash
        run: |
          set -euo pipefail

          IN_YEAR="${{ inputs.year }}"
          IN_MONTH="${{ inputs.month }}"

          if [[ -n "$IN_YEAR" && -n "$IN_MONTH" ]]; then
            YM="$(printf "%04d-%02d" "$IN_YEAR" "$IN_MONTH")"
          else
            LAST_PREV=$(TZ=Australia/Melbourne date -d "$(TZ=Australia/Melbourne date +%Y-%m-01) -1 day" +%Y-%m-%d)
            YM=$(TZ=Australia/Melbourne date -d "$LAST_PREV" +%Y-%m)
          fi

          echo "ym=$YM" >> "$GITHUB_OUTPUT"
          echo "Chosen month: $YM"

      - name: Run generator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODE: backfill-months
          START_YM: ${{ steps.month.outputs.ym }}
          END_YM: ${{ steps.month.outputs.ym }}

          ITEMS_PER_SECTION: "7"
          PER_DOMAIN_CAP: "3"
          MAX_PER_DOMAIN_PER_SECTION: "3"

          MIN_TEXT_CHARS: "300"
          PRIORITY_MIN_CHARS: "200"
          MIN_TOTAL_ITEMS: "1"
          MIN_SUBSTANCE_SCORE: "2"
          ALLOW_UNDATED: "0"

          PRIORITY_DOMAINS: "aemo.com.au,arena.gov.au,cefc.com.au,ifrs.org,efrag.org,dcceew.gov.au,ec.europa.eu,commission.europa.eu"

          MODEL: "gpt-4o-mini"
          TEMP: "0.2"
          DEBUG: "1"

          MAX_LINKS_PER_INDEX: "220"
          MAX_INDEX_PAGES: "4"
          MAX_DATE_RESOLVE_FETCHES_PER_INDEX: "55"
          MAX_FULLTEXT_FETCHES_PER_SECTION: "55"
          MAX_FULLTEXT_FETCHES_TOTAL: "150"

          TIMEOUT_FAST: "15"
          TIMEOUT_PRIORITY: "30"
          RETRIES_FAST: "2"
          RETRIES_PRIORITY: "4"
          FETCH_CACHE_MAX: "900"
        shell: bash
        run: |
          set -euo pipefail
          python -B -m src.generate_monthly

      - name: Print debug summary (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          YM="${{ steps.month.outputs.ym }}"

          echo ""
          echo "==== debug-meta-${YM}.txt (if exists) ===="
          if [[ -f "out/debug-meta-${YM}.txt" ]]; then
            sed -n '1,200p' "out/debug-meta-${YM}.txt"
          else
            echo "(missing)"
          fi

          echo ""
          echo "==== debug-drops-${YM}.txt (first 200 lines, if exists) ===="
          if [[ -f "out/debug-drops-${YM}.txt" ]]; then
            sed -n '1,200p' "out/debug-drops-${YM}.txt"
          else
            echo "(missing)"
          fi

          echo ""
          echo "==== monthly-digest-${YM}.md (head, if exists) ===="
          if [[ -f "out/monthly-digest-${YM}.md" ]]; then
            sed -n '1,120p' "out/monthly-digest-${YM}.md"
          else
            echo "(missing)"
          fi

      - name: Collect artifacts (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          YM="${{ steps.month.outputs.ym }}"

          rm -rf _artifact
          mkdir -p _artifact

          # digest
          cp -f "out/monthly-digest-${YM}.md" _artifact/ 2>/dev/null || true

          # debug
          cp -f "out/debug-selected-${YM}.json" _artifact/ 2>/dev/null || true
          cp -f "out/debug-drops-${YM}.txt" _artifact/ 2>/dev/null || true
          cp -f "out/debug-meta-${YM}.txt" _artifact/ 2>/dev/null || true

          shopt -s nullglob
          for f in out/debug-pool-*-"${YM}".json; do
            cp -f "$f" _artifact/ || true
          done

          echo "Artifact files:"
          ls -lah _artifact || true

      - name: Upload artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-run-${{ steps.month.outputs.ym }}
          path: _artifact
          retention-days: 30
# === END .github/workflows/monthly.yml ===
