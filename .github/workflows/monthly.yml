name: monthly-digest

on:
  schedule:
    - cron: "10 0 1 * *" # 00:10 UTC on the 1st of each month
  workflow_dispatch:
    inputs:
      year:
        description: "Year to backfill (e.g., 2025)"
        required: false
        default: ""
      month:
        description: "Month to backfill (01..12)"
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: monthly-digest
  cancel-in-progress: false

jobs:
  run-monthly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Sync with main (before generation)
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          git pull --rebase origin main

      - name: Setup Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Sanity check fetch module is not corrupted
        run: |
          set -euo pipefail
          python - <<'PY'
          from pathlib import Path
          txt = Path("src/fetch.py").read_text(encoding="utf-8", errors="replace")
          if "def fetch_rss" not in txt or "class Item" not in txt:
              raise SystemExit("ERROR: src/fetch.py does not look like the fetch module (missing Item/fetch_rss)")
          if "from .fetch import fetch_rss" in txt:
              raise SystemExit("ERROR: src/fetch.py contains a self-import (will cause circular import)")
          print("OK: fetch module looks valid")
          PY
         
      - name: Sanity check generate_monthly has robust _in_range
        run: |
          set -euo pipefail
          python - <<'PY'
          import inspect
          import src.generate_monthly as gm
          print("Loaded:", gm.__file__)
          src = inspect.getsource(gm._in_range)
          print(src)

          # Hard fail if we detect the old implementation pattern
          if "return start_ts <= ts <= end_ts" in src:
            raise SystemExit("ERROR: old _in_range() still present (datetime/float TypeError will occur)")

          # Also require the new coercion helper to be referenced
          if "_coerce_ts" not in src:
            raise SystemExit("ERROR: _in_range() is not coercing timestamp types")

          print("OK: _in_range looks robust")
          PY

      - name: Compute target month (prev month in Australia/Melbourne, unless inputs provided)
        id: when
        shell: bash
        run: |
          set -euo pipefail

          IN_YEAR="${{ github.event.inputs.year || '' }}"
          IN_MONTH="${{ github.event.inputs.month || '' }}"

          if [[ -n "$IN_YEAR" && -n "$IN_MONTH" ]]; then
            YM="$(printf "%04d-%02d" "$IN_YEAR" "$IN_MONTH")"
          else
            LAST_PREV=$(TZ=Australia/Melbourne date -d "$(TZ=Australia/Melbourne date +%Y-%m-01) -1 day" +%Y-%m-%d)
            YM=$(TZ=Australia/Melbourne date -d "$LAST_PREV" +%Y-%m)
          fi

          echo "ym=$YM" >> "$GITHUB_OUTPUT"
          echo "Chosen month: $YM"

      - name: Generate monthly digest (DEBUG always on)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODE: backfill-months
          START_YM: ${{ steps.when.outputs.ym }}
          END_YM: ${{ steps.when.outputs.ym }}

          ITEMS_PER_SECTION: "7"
          PER_DOMAIN_CAP: "3"
          MIN_TEXT_CHARS: "300"
          PRIORITY_MIN_CHARS: "200"
          MIN_TOTAL_ITEMS: "1"

          PRIORITY_DOMAINS: "aemo.com.au,arena.gov.au,cefc.com.au,ifrs.org,efrag.org,dcceew.gov.au,ec.europa.eu,commission.europa.eu"
          MODEL: "gpt-4o-mini"
          TEMP: "0.2"

          MAX_PDF_BYTES: "5242880"
          PDF_TRUSTED: "aemo.com.au,ifrs.org,efrag.org,dcceew.gov.au,arena.gov.au,cefc.com.au,irena.org"

          DEBUG: "1"
          
          # Make HTML index scraping robust against months buried behind pagination
          MAX_LINKS_PER_INDEX: "250"
          MAX_INDEX_PAGES: "5"
          MAX_DATE_RESOLVE_FETCHES_PER_INDEX: "75"
          
        run: |
          python -m src.generate_monthly

      - name: Guardrail - require at least 1 selected item
        shell: bash
        run: |
          set -euo pipefail
          YM="${{ steps.when.outputs.ym }}"
          f="out/debug-selected-${YM}.json"

          if [[ ! -f "$f" ]]; then
            echo "Missing selected file: $f"
            exit 1
          fi

          n="$(jq -r 'length' "$f")"
          echo "selected_count=$n"
          if [[ "$n" -lt 1 ]]; then
            echo "ERROR: selected items is $n but MIN_TOTAL_ITEMS=1. Failing run to avoid publishing placeholder."
            exit 1
          fi

      - name: Commit outputs (digest + current-month debug)
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "content-bot"
          git config user.email "content-bot@example.com"

          YM="${{ steps.when.outputs.ym }}"
          DIGEST="out/monthly-digest-${YM}.md"

          test -f "$DIGEST" || { echo "Digest not found: $DIGEST"; exit 1; }

          # Never commit pycache
          rm -rf src/__pycache__ || true

          # Stage only this month's artifacts
          git add -f "$DIGEST"
          git add -f "out/debug-selected-${YM}.json" 2>/dev/null || true
          git add -f "out/debug-drops-${YM}.txt" 2>/dev/null || true
          git add -f "out/debug-meta-${YM}.txt" 2>/dev/null || true

          shopt -s nullglob
          pool_files=(out/debug-pool-*-"${YM}".json)
          if (( ${#pool_files[@]} )); then
            git add -f "${pool_files[@]}"
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          echo "---- git status (porcelain) ----"
          git status --porcelain

          git commit -m "monthly: digest ${YM} (debug=on)"
          git push origin HEAD:main

      - name: Prepare debug bundle (current month only)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          YM="${{ steps.when.outputs.ym }}"

          rm -rf _artifact
          mkdir -p _artifact

          cp -f "out/debug-selected-${YM}.json" _artifact/ 2>/dev/null || true
          cp -f "out/debug-drops-${YM}.txt" _artifact/ 2>/dev/null || true
          cp -f "out/debug-meta-${YM}.txt" _artifact/ 2>/dev/null || true

          shopt -s nullglob
          for f in out/debug-pool-*-"${YM}".json; do
            cp -f "$f" _artifact/ || true
          done

          echo "Artifact files:"
          ls -lah _artifact || true

      - name: Upload debug bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-debug-${{ steps.when.outputs.ym }}
          path: _artifact
          if-no-files-found: warn
          retention-days: 30

      - name: Email monthly digest (iCloud)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.me.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GG Advisory | Monthly Digest (${{ steps.when.outputs.ym }})"
          from: "GG Advisory <${{ secrets.MAIL_USERNAME }}>"
          to: "a.demazy_de_fortet@icloud.com"
          body: |
            âœ… Monthly digest for ${{ steps.when.outputs.ym }} attached.
            Repo: https://github.com/${{ github.repository }}/tree/main/out
            Debug: always on
          attachments: |
            out/monthly-digest-${{ steps.when.outputs.ym }}.md
            out/debug-selected-${{ steps.when.outputs.ym }}.json
            out/debug-drops-${{ steps.when.outputs.ym }}.txt
            out/debug-meta-${{ steps.when.outputs.ym }}.txt
