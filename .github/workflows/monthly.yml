name: monthly-digest

on:
  schedule:
    # 00:10 UTC on the 1st of each month
    - cron: "10 0 1 * *"
  workflow_dispatch:
    inputs:
      year:
        description: "Year to backfill (e.g., 2025)"
        required: false
        default: ""
      month:
        description: "Month to backfill (01..12)"
        required: false
        default: ""
      debug:
        description: "Enable verbose debug artifacts"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: write

concurrency:
  group: monthly-digest
  cancel-in-progress: false

jobs:
  run-monthly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compute target month (prev month in Australia/Melbourne, unless inputs provided)
        id: when
        shell: bash
        run: |
          set -euo pipefail

          IN_YEAR="${{ github.event.inputs.year || '' }}"
          IN_MONTH="${{ github.event.inputs.month || '' }}"

          if [[ -n "$IN_YEAR" && -n "$IN_MONTH" ]]; then
            YM="$(printf "%04d-%02d" "$IN_YEAR" "$IN_MONTH")"
          else
            # Previous month in Australia/Melbourne:
            # Take the first of the current month, subtract one day -> last day of previous month
            LAST_PREV=$(TZ=Australia/Melbourne date -d "$(TZ=Australia/Melbourne date +%Y-%m-01) -1 day" +%Y-%m-%d)
            YM=$(TZ=Australia/Melbourne date -d "$LAST_PREV" +%Y-%m)
          fi

          echo "ym=$YM" >> "$GITHUB_OUTPUT"
          echo "Chosen month: $YM"

      - name: Compute debug flag
        id: flags
        shell: bash
        run: |
          set -euo pipefail
          # For scheduled runs, inputs are empty -> treat as false
          DBG="${{ github.event.inputs.debug || 'false' }}"
          if [[ "$DBG" == "true" ]]; then
            echo "debug=1" >> "$GITHUB_OUTPUT"
            echo "debug_bool=true" >> "$GITHUB_OUTPUT"
          else
            echo "debug=0" >> "$GITHUB_OUTPUT"
            echo "debug_bool=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate monthly digest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODE: backfill-months
          START_YM: ${{ steps.when.outputs.ym }}
          END_YM:   ${{ steps.when.outputs.ym }}

          # ----- Content tuning -----
          ITEMS_PER_SECTION: "7"
          PER_DOMAIN_CAP: "3"
          MIN_TEXT_CHARS: "300"
          PRIORITY_MIN_CHARS: "200"
          MIN_TOTAL_ITEMS: "1"

          PRIORITY_DOMAINS: "aemo.com.au,arena.gov.au,cefc.com.au,ifrs.org,efrag.org,dcceew.gov.au,ec.europa.eu,commission.europa.eu"
          MODEL: gpt-4o-mini
          TEMP: "0.2"

          # ----- Hybrid PDF capture -----
          MAX_PDF_BYTES: "5242880"
          PDF_TRUSTED: "aemo.com.au,ifrs.org,efrag.org,dcceew.gov.au,arena.gov.au,cefc.com.au,irena.org"

          # ----- Debug toggle -----
          DEBUG: ${{ steps.flags.outputs.debug }}
        run: python -m src.generate_monthly

      - name: List outputs
        if: always()
        run: |
          echo "---- OUT ----"
          ls -lh out/ | sed -n '1,400p' || true
          echo "---- SELECTED (count) ----"
          f="out/debug-selected-${{ steps.when.outputs.ym }}.json"
          test -f "$f" && { echo -n "$f: "; jq -r 'length' "$f"; } || true
          echo "---- DROPS (first 40 lines) ----"
          f2="out/debug-drops-${{ steps.when.outputs.ym }}.txt"
          test -f "$f2" && head -n 40 "$f2" || true

      # Commit ONLY the digest by default (keeps repo clean)
      - name: Commit digest
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          git config user.name "content-bot"
          git config user.email "content-bot@example.com"

          DIGEST="out/monthly-digest-${{ steps.when.outputs.ym }}.md"
          git add -f "$DIGEST"

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "monthly: digest ${{ steps.when.outputs.ym }}"
          git pull --rebase
          git push

      # Upload debug artifacts (only when debug=true)
      - name: Upload debug artifacts
        if: ${{ steps.flags.outputs.debug_bool == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: monthly-debug-${{ steps.when.outputs.ym }}
          path: |
            out/debug-selected-${{ steps.when.outputs.ym }}.json
            out/debug-drops-${{ steps.when.outputs.ym }}.txt
            out/debug-pool-*
            out/debug-meta-${{ steps.when.outputs.ym }}.txt
          if-no-files-found: warn
          retention-days: 30

      - name: Email monthly digest (iCloud)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.me.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GG Advisory | Monthly Digest (${{ steps.when.outputs.ym }})"
          from: "GG Advisory <${{ secrets.MAIL_USERNAME }}>"
          to: "a.demazy_de_fortet@icloud.com"
          body: |
            âœ… Monthly digest for ${{ steps.when.outputs.ym }} attached.
            Repo: https://github.com/${{ github.repository }}/tree/main/out
            Debug enabled: ${{ steps.flags.outputs.debug_bool }}
          attachments: |
            out/monthly-digest-${{ steps.when.outputs.ym }}.md
